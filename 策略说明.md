# TQQQ智能交易策略说明文档

## 📊 策略概述

TQQQ智能交易策略是一个基于EMA20移动平均线的自动化交易策略，专门用于交易TQQQ（3倍杠杆纳斯达克ETF）。

## 🎯 策略核心逻辑

### 交易信号
- **买入条件**: 昨日TQQQ收盘价 > EMA20移动平均线
- **仓位大小**: 账户总资金的10%
- **交易时间**: 每天北京时间21:20自动检查
- **交易模式**: 实盘交易（将实际扣款）

## 🔄 策略执行流程

### 第一步：环境初始化
```python
# 1. 创建策略实例
strategy = TQQQSmartTradingStrategy(
    host='127.0.0.1',    # IB Gateway地址
    port=4001,           # IB Gateway端口
    client_id=444        # 客户端ID
)
```

### 第二步：连接IB Gateway
```python
# 2. 连接到Interactive Brokers Gateway
def connect_to_ib(self):
    self.ib = IB()
    self.ib.connect(self.host, self.port, clientId=self.client_id, timeout=20)
```
- 建立与IB Gateway的连接
- 验证连接状态
- 设置超时时间

### 第三步：创建交易合约
```python
# 3. 创建TQQQ股票合约
def create_contracts(self):
    self.tqqq_contract = Stock('TQQQ', 'SMART', 'USD')
    tqqq_contracts = self.ib.qualifyContracts(self.tqqq_contract)
```
- 创建TQQQ股票合约对象
- 验证合约信息
- 确保合约可用

### 第四步：获取历史数据
```python
# 4. 获取TQQQ历史价格数据
def get_historical_data(self, contract, duration='30 D'):
    bars = self.ib.reqHistoricalData(
        contract,
        endDateTime='',
        durationStr=duration,
        barSizeSetting='1 day',
        whatToShow='TRADES',
        useRTH=True
    )
```
- 获取30天的日线数据
- 包含开盘价、最高价、最低价、收盘价
- 用于计算技术指标

### 第五步：计算技术指标
```python
# 5. 计算EMA20移动平均线
def calculate_ema(self, prices, period=20):
    return prices.ewm(span=period).mean()
```
- 计算20日指数移动平均线
- 使用pandas的ewm函数
- 平滑价格波动

### 第六步：分析交易条件
```python
# 6. 分析是否满足交易条件
def analyze_trading_conditions(self):
    # 获取昨日数据
    yesterday_close = tqqq_data.iloc[-2]['close']  # 昨日收盘价
    yesterday_ema20 = tqqq_data.iloc[-2]['ema20']  # 昨日EMA20
    
    # 判断信号
    if yesterday_close > yesterday_ema20:
        return True, current_price  # 满足买入条件
    else:
        return False, current_price  # 不满足条件
```

### 第七步：获取账户信息
```python
# 7. 获取账户总价值
def get_account_value(self):
    account_values = self.ib.accountSummary()
    for value in account_values:
        if value.tag == 'NetLiquidation' and value.currency == 'USD':
            return float(value.value)
```
- 获取账户净资产
- 用于计算仓位大小

### 第八步：计算仓位大小
```python
# 8. 计算买入股数
def calculate_position_size(self, percentage=0.1):
    account_value = self.get_account_value()
    available_funds = account_value * percentage  # 10%资金
    current_price = self.get_current_tqqq_price()
    quantity = int(available_funds / current_price)  # 向下取整
```
- 使用账户资金的10%
- 根据当前价格计算可买入股数
- 确保至少买入1股

### 第九步：获取当前价格
```python
# 9. 获取TQQQ实时价格
def get_current_tqqq_price(self):
    ticker = self.ib.reqMktData(self.tqqq_contract)
    # 等待价格数据
    while time.time() - start_time < max_wait:
        if ticker.marketPrice() > 0:
            return ticker.marketPrice()
```
- 获取TQQQ实时市场价格
- 如果无法获取实时价格，使用历史数据

### 第十步：执行买入订单
```python
# 10. 下买单
def place_buy_order(self, percentage=0.1):
    quantity = self.calculate_position_size(percentage)
    order = MarketOrder('BUY', quantity)  # 市价单
    order.outsideRth = True  # 允许常规交易时间以外交易
    trade = self.ib.placeOrder(self.tqqq_contract, order)
```
- 创建市价买单
- 支持常规交易时间以外交易
- 监控订单执行状态

### 第十一步：时间检查
```python
# 11. 检查是否应该执行策略
def should_check_today(self):
    beijing_time = datetime.now(self.beijing_tz)
    current_time = beijing_time.time()
    target_time = datetime.strptime('21:20', '%H:%M').time()
    
    # 允许5分钟误差
    time_diff = abs((current_time.hour * 60 + current_time.minute) - 
                  (target_time.hour * 60 + target_time.minute))
    
    return time_diff <= 5
```
- 检查当前北京时间
- 在21:20±5分钟内执行策略
- 避免重复执行

## 📅 策略执行时间表

| 时间 | 操作 | 说明 |
|------|------|------|
| 每天21:20 | 自动检查 | 检查交易条件 |
| 满足条件时 | 立即买入 | 使用10%账户资金 |
| 不满足条件 | 跳过 | 等待下一天 |

## ⚠️ 风险提示

1. **实盘交易**: 这是实盘交易策略，将实际扣款并执行交易
2. **杠杆风险**: TQQQ是3倍杠杆ETF，波动较大
3. **市场风险**: 股市有风险，投资需谨慎
4. **技术风险**: 依赖网络连接和IB Gateway稳定性

## 🔧 使用前准备

1. **安装IB Gateway**: 确保IB Gateway已启动并监听端口4001
2. **账户资金**: 确保账户有足够资金进行交易
3. **网络连接**: 确保网络连接稳定
4. **权限设置**: 确保账户有交易TQQQ的权限

## 📁 文件说明

- `tqqq_final_trading.py`: 主策略文件
- `test_strategy.py`: 策略测试文件
- `启动策略.bat`: 策略启动脚本
- `测试策略.bat`: 策略测试脚本
- `requirements.txt`: 依赖包列表

## 🚀 启动方式

1. **直接启动**: 双击 `启动策略.bat`
2. **测试模式**: 双击 `测试策略.bat`
3. **手动运行**: 
   ```bash
   cd ib_async
   venv\Scripts\activate
   python tqqq_final_trading.py
   ```

## 📊 策略监控

- 日志文件: `tqqq_trading.log`
- 实时输出: 控制台显示
- 交易记录: IB账户历史

## 🔄 策略优化建议

1. **参数调整**: 可以调整EMA周期和资金比例
2. **风险控制**: 可以添加止损和止盈机制
3. **信号优化**: 可以结合其他技术指标
4. **时间优化**: 可以调整检查时间频率 