# TQQQ智能交易策略部署指南

## 🎯 部署方案选择

### 方案一：Docker容器化部署（推荐）
- **优点**: 环境一致、易于管理、快速部署
- **适用**: 生产环境、多机器部署
- **要求**: 目标机器安装Docker和Docker Compose

### 方案二：传统部署
- **优点**: 简单直接、资源占用少
- **适用**: 单机测试、开发环境
- **要求**: 目标机器安装Python 3.8+

## 🐳 方案一：Docker部署

### 1. 环境准备

#### 安装Docker
```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# CentOS/RHEL
sudo yum install -y docker
sudo systemctl start docker
sudo systemctl enable docker

# Windows
# 下载并安装 Docker Desktop
```

#### 安装Docker Compose
```bash
# Linux
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Windows (Docker Desktop已包含)
```

### 2. 项目部署

#### 克隆项目
```bash
git clone https://github.com/ddddogshark/IB_Trading.git
cd IB_Trading
```

#### 创建配置文件
```bash
# 创建配置目录
mkdir -p config ib-config logs

# 创建IB Gateway配置文件
cat > ib-config/ibgateway.yaml << EOF
ibgateway:
  port: 4001
  host: 0.0.0.0
  log_level: INFO
  paper_trading: false
EOF
```

#### 启动服务
```bash
# 构建并启动
docker-compose up -d

# 查看日志
docker-compose logs -f tqqq-trading

# 停止服务
docker-compose down
```

### 3. 监控和管理

#### 查看服务状态
```bash
docker-compose ps
docker-compose logs tqqq-trading
```

#### 重启服务
```bash
docker-compose restart tqqq-trading
```

#### 更新代码
```bash
git pull
docker-compose build --no-cache
docker-compose up -d
```

## 💻 方案二：传统部署

### 1. 环境准备

#### 安装Python
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3.12 python3.12-venv python3-pip

# CentOS/RHEL
sudo yum install python3.12 python3.12-pip

# Windows
# 下载Python 3.12安装包
```

#### 安装IB Gateway
```bash
# 下载IB Gateway
wget https://download2.interactivebrokers.com/portal/clientportal.gw.zip
unzip clientportal.gw.zip -d /opt/ib-gateway

# 配置IB Gateway
cat > /opt/ib-gateway/config.yaml << EOF
ibgateway:
  port: 4001
  host: 0.0.0.0
  log_level: INFO
  paper_trading: false
EOF
```

### 2. 项目部署

#### 克隆项目
```bash
git clone https://github.com/ddddogshark/IB_Trading.git
cd IB_Trading
```

#### 创建虚拟环境
```bash
python3.12 -m venv venv
source venv/bin/activate  # Linux
# 或
venv\Scripts\activate     # Windows
```

#### 安装依赖
```bash
pip install -r requirements.txt
```

#### 启动IB Gateway
```bash
# 后台启动
nohup /opt/ib-gateway/bin/run.sh > ib-gateway.log 2>&1 &

# 或使用systemd服务
sudo systemctl start ib-gateway
sudo systemctl enable ib-gateway
```

#### 启动交易策略
```bash
# 直接运行
python ib_async/tqqq_final_trading.py

# 后台运行
nohup python ib_async/tqqq_final_trading.py > trading.log 2>&1 &

# 使用screen
screen -S trading
python ib_async/tqqq_final_trading.py
# Ctrl+A+D 分离screen
```

### 3. 系统服务配置

#### 创建systemd服务文件
```bash
sudo cat > /etc/systemd/system/tqqq-trading.service << EOF
[Unit]
Description=TQQQ Trading Strategy
After=network.target

[Service]
Type=simple
User=trading
WorkingDirectory=/home/trading/IB_Trading
Environment=PATH=/home/trading/IB_Trading/venv/bin
ExecStart=/home/trading/IB_Trading/venv/bin/python ib_async/tqqq_final_trading.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# 启用服务
sudo systemctl daemon-reload
sudo systemctl enable tqqq-trading
sudo systemctl start tqqq-trading
```

## 🔧 配置管理

### 环境变量配置
```bash
# 创建环境配置文件
cat > .env << EOF
# IB Gateway配置
IB_HOST=127.0.0.1
IB_PORT=4001
IB_CLIENT_ID=444

# 策略配置
EMA_PERIOD=20
POSITION_PERCENTAGE=0.1
CHECK_TIME=21:20

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=tqqq_trading.log
EOF
```

### 配置文件
```bash
# 创建策略配置文件
cat > config/strategy_config.yaml << EOF
# 连接配置
connection:
  host: 127.0.0.1
  port: 4001
  client_id: 444
  timeout: 20

# 策略配置
strategy:
  ema_period: 20
  position_percentage: 0.1
  check_time: "21:20"
  timezone: "Asia/Shanghai"

# 风险控制
risk_management:
  max_position_size: 0.1
  stop_loss: 0.05
  take_profit: 0.15

# 日志配置
logging:
  level: INFO
  file: logs/tqqq_trading.log
  max_size: 100MB
  backup_count: 5
EOF
```

## 📊 监控和日志

### 日志管理
```bash
# 查看实时日志
tail -f logs/tqqq_trading.log

# 日志轮转配置
sudo cat > /etc/logrotate.d/tqqq-trading << EOF
/home/trading/IB_Trading/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 trading trading
    postrotate
        systemctl reload tqqq-trading
    endscript
}
EOF
```

### 监控脚本
```bash
# 创建监控脚本
cat > monitor.sh << 'EOF'
#!/bin/bash

# 检查策略进程
if ! pgrep -f "tqqq_final_trading.py" > /dev/null; then
    echo "$(date): 策略进程未运行，正在重启..."
    systemctl restart tqqq-trading
fi

# 检查IB Gateway连接
if ! nc -z 127.0.0.1 4001; then
    echo "$(date): IB Gateway连接失败"
fi

# 检查日志文件大小
log_size=$(du -m logs/tqqq_trading.log | cut -f1)
if [ $log_size -gt 100 ]; then
    echo "$(date): 日志文件过大，正在轮转..."
    logrotate /etc/logrotate.d/tqqq-trading
fi
EOF

chmod +x monitor.sh

# 添加到crontab
echo "*/5 * * * * /home/trading/IB_Trading/monitor.sh" | crontab -
```

## 🔒 安全配置

### 防火墙配置
```bash
# 只允许必要的端口
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 4001/tcp  # IB Gateway
sudo ufw enable
```

### 用户权限
```bash
# 创建专用用户
sudo useradd -m -s /bin/bash trading
sudo usermod -aG docker trading

# 设置目录权限
sudo chown -R trading:trading /home/trading/IB_Trading
sudo chmod 700 /home/trading/IB_Trading
```

## 🚀 快速部署脚本

### Docker快速部署
```bash
#!/bin/bash
# deploy-docker.sh

echo "开始Docker部署..."

# 检查Docker
if ! command -v docker &> /dev/null; then
    echo "Docker未安装，正在安装..."
    curl -fsSL https://get.docker.com -o get-docker.sh
    sudo sh get-docker.sh
fi

# 检查Docker Compose
if ! command -v docker-compose &> /dev/null; then
    echo "Docker Compose未安装，正在安装..."
    sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
fi

# 克隆项目
if [ ! -d "IB_Trading" ]; then
    git clone https://github.com/ddddogshark/IB_Trading.git
fi

cd IB_Trading

# 创建必要目录
mkdir -p logs config ib-config

# 启动服务
docker-compose up -d

echo "部署完成！"
echo "查看日志: docker-compose logs -f tqqq-trading"
echo "停止服务: docker-compose down"
```

### 传统部署脚本
```bash
#!/bin/bash
# deploy-traditional.sh

echo "开始传统部署..."

# 检查Python
if ! command -v python3.12 &> /dev/null; then
    echo "Python 3.12未安装，请先安装Python 3.12"
    exit 1
fi

# 克隆项目
if [ ! -d "IB_Trading" ]; then
    git clone https://github.com/ddddogshark/IB_Trading.git
fi

cd IB_Trading

# 创建虚拟环境
python3.12 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 创建配置
mkdir -p logs config

# 启动策略
echo "启动策略..."
python ib_async/tqqq_final_trading.py
```

## 📋 部署检查清单

### 部署前检查
- [ ] 目标机器满足系统要求
- [ ] 网络连接正常
- [ ] IB账户配置正确
- [ ] 防火墙配置完成
- [ ] 用户权限设置正确

### 部署后验证
- [ ] IB Gateway连接正常
- [ ] 策略进程运行正常
- [ ] 日志文件正常生成
- [ ] 监控脚本正常工作
- [ ] 自动重启功能正常

### 性能监控
- [ ] CPU使用率
- [ ] 内存使用情况
- [ ] 磁盘空间
- [ ] 网络连接状态
- [ ] 日志文件大小

## 🆘 故障排除

### 常见问题
1. **IB Gateway连接失败**
   - 检查端口4001是否开放
   - 确认IB Gateway进程运行
   - 检查网络连接

2. **策略启动失败**
   - 检查Python环境
   - 确认依赖包安装完整
   - 查看错误日志

3. **权限问题**
   - 确认用户权限设置
   - 检查文件权限
   - 验证目录访问权限

### 日志分析
```bash
# 查看错误日志
grep -i error logs/tqqq_trading.log

# 查看连接日志
grep -i connect logs/tqqq_trading.log

# 查看交易日志
grep -i trade logs/tqqq_trading.log
```

## 📞 技术支持

如遇部署问题，请：
1. 查看详细错误日志
2. 检查系统资源使用情况
3. 确认网络连接状态
4. 联系技术支持团队 